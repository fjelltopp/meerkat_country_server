version: '2'
services:
  odk:
    build: odk
    container_name: odk
    tty: true
    depends_on:
      - db
    links:
      - db
    environment:
      - ODK_HOSTNAME=localhost
      - ODK_ADMIN_USERNAME=test
      - ODK_PORT=80
      - ODK_PORT_SECURE=443
      - DB_USER=odk_user
      - DB_DATABASE=odk_db
      - DB_SCHEMA=odk_db
      - DB_PASSWORD=password
      - DB_HOSTNAME=db
      - PGPASSWORD=password

  db:
    build:
      context: .
      dockerfile: db/Dockerfile
    container_name: db
    ports:
      - "5432:5432"
    volumes:
      - database_volume:/var/lib/postgresql/
      - ./db/postgresql.conf:/etc/postgresql.conf
      - /etc/wal-e.d/env/:/etc/wal-e.d/env/
      - /etc/wal-e.d/gpg_pub.key:/etc/wal-e.d/gpg_pub.key
      - ./db/add_gpg_key.sh:/docker-entrypoint-initdb.d/add_gpg_key.sh
      - ./db/trust_gpg.exp:/usr/bin/trust_gpg.exp
    environment:
      - POSTGRES_PASSWORD=password
    command: postgres -c config_file=/etc/postgresql.conf

  nest:
    build: nest
    ports:
      - "5000:5000"
    volumes:
      - "../meerkat_nest/:/var/www/meerkat_nest"
      - "~/.aws/credentials:/root/.aws/credentials"
    environment:
      - "CONFIG_OBJECT=config.Development"
      - "MEERKAT_NEST_DB_URL=postgresql+psycopg2://postgres:password@db/meerkat_nest_db"
    hostname: nest

  nest_rabbit:
    image: rabbitmq
    hostname: nest_rabbit

  tunnel:
     image: vsouza/sqs-local
     hostname: tunnel
     ports:
      - 9324:9324

  nginx:
    build: nginx
    ports:
      - "80:80"
      - "443:443"
    environment:
      - "SSL_CERTIFICATE=/etc/nginx/self-signed-nginx.crt"
      - "SSL_CERTIFICATE_KEY=/etc/nginx/self-signed-nginx.key"
    depends_on:
      - odk
      - nest
    hostname: nginx
    command: /bin/run.sh
volumes:
  database_volume:
